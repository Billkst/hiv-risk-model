# API使用示例 - 详细说明

## 📋 目录
- [模型功能说明](#模型功能说明)
- [4个主要接口](#4个主要接口)
- [详细使用示例](#详细使用示例)
- [完整特征列表](#完整特征列表)
- [常见场景](#常见场景)

---

## 模型功能说明

### 🎯 模型是做什么的？

这是一个**HIV风险评估模型**，用于预测某个区县的HIV疫情风险等级。

**输入**: 区县的各种数据（人口、感染数、治疗情况等110个特征）  
**输出**: 风险等级（1-5级）+ 风险分数（0-100分）

### 📊 风险等级说明

| 等级 | 名称 | 分数范围 | 含义 | 建议措施 |
|------|------|----------|------|----------|
| 1 | 极低风险 | 0-20分 | 疫情控制良好 | 保持现有措施 |
| 2 | 低风险 | 20-40分 | 疫情较为稳定 | 继续监测 |
| 3 | 中等风险 | 40-60分 | 需要关注 | 加强干预 |
| 4 | 高风险 | 60-80分 | 需要重点关注 | 立即采取措施 |
| 5 | 极高风险 | 80-100分 | 疫情严重 | 紧急干预 |

### 🔍 模型特点

- **轻量级**: 仅66K参数，响应快速（<50ms）
- **准确**: 基于190个区县的真实数据训练
- **可解释**: 基于决策树，可追踪决策过程
- **实用**: 直接输出可操作的风险等级

---

## 4个主要接口

### 接口1: 健康检查 ✅

**用途**: 检查服务是否正常运行

```bash
GET /health
```

**什么时候用？**
- 服务刚启动时，检查是否就绪
- 定期监控服务状态
- 排查服务故障

**示例**:
```bash
curl http://localhost:5000/health
```

**响应**:
```json
{
  "status": "healthy",
  "model_loaded": true,
  "timestamp": "2024-01-01T12:00:00"
}
```

---

### 接口2: 获取模型信息 📊

**用途**: 查看模型需要哪些特征，支持哪些功能

```bash
GET /v1/model/info
```

**什么时候用？**
- 第一次使用API时，了解需要提供哪些数据
- 查看模型版本和配置
- 了解风险等级定义

**示例**:
```bash
curl http://localhost:5000/v1/model/info
```

**响应**:
```json
{
  "model_name": "Gradient Boosting",
  "model_version": "1.0.0",
  "feature_count": 110,
  "features": [
    "存活数",
    "感染率",
    "治疗覆盖率",
    "..."
  ],
  "risk_levels": {
    "1": "极低风险 (0-20分)",
    "2": "低风险 (20-40分)",
    "3": "中等风险 (40-60分)",
    "4": "高风险 (60-80分)",
    "5": "极高风险 (80-100分)"
  }
}
```

---

### 接口3: 单样本预测 🎯

**用途**: 预测单个区县的风险等级

```bash
POST /v1/predict
```

**什么时候用？**
- 评估某个具体区县的风险
- 实时查询单个区县的情况
- 在网页或APP中展示单个区县的风险

**完整示例**:

```bash
curl -X POST http://localhost:5000/v1/predict \
  -H "Content-Type: application/json" \
  -d '{
    "features": {
      "存活数": 1000,
      "感染率": 0.5,
      "存活_0-": 0.0,
      "存活_5-": 0.0,
      "存活_10-": 0.0,
      "存活_15-": 1.0,
      "存活_20-": 2.5,
      "存活_25-": 5.0,
      "存活_30-": 8.0,
      "存活_35-": 10.0,
      "存活_40-": 12.0,
      "存活_45-": 15.0,
      "存活_50-": 14.0,
      "存活_55-": 12.0,
      "存活_60-": 8.0,
      "存活_65-": 6.0,
      "存活_70-": 4.0,
      "存活_75-": 2.0,
      "存活_80-": 1.0,
      "存活_同性传播": 10.0,
      "存活_配偶阳性": 8.0,
      "存活_商业性行为": 35.0,
      "存活_非婚非商业": 30.0,
      "存活_非婚未分类": 10.0,
      "存活_注射毒品": 5.0,
      "存活_母婴传播": 1.0,
      "存活_其他或不详": 1.0,
      "新报告": 50,
      "新报告_0-": 0.0,
      "新报告_5-": 0.0,
      "新报告_10-": 0.0,
      "新报告_15-": 2.0,
      "新报告_20-": 5.0,
      "新报告_25-": 8.0,
      "新报告_30-": 10.0,
      "新报告_35-": 12.0,
      "新报告_40-": 15.0,
      "新报告_45-": 18.0,
      "新报告_50-": 15.0,
      "新报告_55-": 10.0,
      "新报告_60-": 5.0,
      "新报告_65-": 0.0,
      "新报告_70-": 0.0,
      "新报告_75-": 0.0,
      "新报告_80-": 0.0,
      "新报告_同性传播": 15.0,
      "新报告_配偶阳性": 10.0,
      "新报告_商业性行为": 20.0,
      "新报告_非婚非商业": 40.0,
      "新报告_非婚未分类": 10.0,
      "新报告_注射毒品": 3.0,
      "新报告_母婴传播": 1.0,
      "新报告_其他或不详": 1.0,
      "治疗覆盖率": 85.0,
      "30天治疗比例": 90.0,
      "检测比例": 95.0,
      "病毒抑制比例": 92.0,
      "病载小于50占现存活比例": 88.0,
      "暗娼_月均估计数": 100.0,
      "暗娼_月均干预人数": 80.0,
      "暗娼_月均覆盖率": 80.0,
      "暗娼_HIV检测人数": 150.0,
      "暗娼_HIV检测阳性人数": 2.0,
      "MSM_月均估计数": 200.0,
      "MSM_月均干预人数": 150.0,
      "MSM_月均覆盖率": 75.0,
      "MSM_HIV检测人数": 180.0,
      "MSM_HIV检测阳性人数": 5.0,
      "吸毒者_月均估计数": 50.0,
      "吸毒者_月均干预人数": 40.0,
      "吸毒者_月均覆盖率": 80.0,
      "吸毒者_HIV检测人数": 45.0,
      "吸毒者_HIV检测阳性人数": 1.0,
      "性病就诊者_干预人数": 500.0,
      "性病就诊者_HIV检测人数": 450.0,
      "性病就诊者_本年累计HIV检测率": 90.0,
      "性病就诊者_HIV检测阳性人数": 3.0,
      "外来务工_月均估计数": 1000.0,
      "外来务工_月均干预人数": 800.0,
      "外来务工_月均覆盖率": 80.0,
      "外来务工_HIV检测人数": 900.0,
      "外来务工_HIV检测阳性人数": 5.0,
      "其他人群_月均估计数": 500.0,
      "其他人群_月均干预人数": 400.0,
      "其他人群_月均覆盖率": 80.0,
      "其他人群_HIV检测人数": 450.0,
      "其他人群_HIV检测阳性人数": 2.0,
      "注射吸毒者规模": 100.0,
      "城市MSM规模": 500.0,
      "暗娼规模": 200.0,
      "嫖客规模": 1000.0,
      "农村MSM规模": 100.0,
      "移动评估MSM人数": 50.0,
      "人口数": 500000.0,
      "筛查人次数": 100000.0,
      "筛查覆盖率": 20.0,
      "筛查人数": 80000.0,
      "按人数筛查覆盖率": 16.0,
      "挡获暗娼人次数": 50.0,
      "暗娼HIV检测阳性率": 2.0,
      "既往阳性暗娼数": 1.0,
      "挡获嫖客人次数": 100.0,
      "嫖客HIV检测阳性率": 1.0,
      "既往阳性嫖客数": 1.0
    }
  }'
```

**响应**:
```json
{
  "success": true,
  "prediction": {
    "risk_level": 3,
    "risk_description": "中等风险",
    "risk_score": 52.34,
    "confidence": 0.9234,
    "confidence_percent": "92.34%"
  },
  "timestamp": "2024-01-01T12:00:00"
}
```

**响应字段说明**:
- `risk_level`: 风险等级（1-5）
- `risk_description`: 风险描述（中文）
- `risk_score`: 风险分数（0-100）
- `confidence`: 预测置信度（0-1）
- `confidence_percent`: 置信度百分比

---

### 接口4: 批量预测 📦

**用途**: 一次预测多个区县的风险等级

```bash
POST /v1/predict/batch
```

**什么时候用？**
- 评估多个区县的风险
- 生成区域风险报告
- 批量数据处理

**示例**:

```bash
curl -X POST http://localhost:5000/v1/predict/batch \
  -H "Content-Type: application/json" \
  -d '{
    "samples": [
      {
        "存活数": 1000,
        "感染率": 0.5,
        "治疗覆盖率": 85.0,
        "人口数": 500000
      },
      {
        "存活数": 2000,
        "感染率": 0.3,
        "治疗覆盖率": 90.0,
        "人口数": 800000
      },
      {
        "存活数": 500,
        "感染率": 0.8,
        "治疗覆盖率": 75.0,
        "人口数": 300000
      }
    ]
  }'
```

**响应**:
```json
{
  "success": true,
  "total": 3,
  "predictions": [
    {
      "index": 0,
      "success": true,
      "risk_level": 3,
      "risk_description": "中等风险",
      "risk_score": 52.34,
      "confidence": 0.9234
    },
    {
      "index": 1,
      "success": true,
      "risk_level": 2,
      "risk_description": "低风险",
      "risk_score": 28.56,
      "confidence": 0.9567
    },
    {
      "index": 2,
      "success": true,
      "risk_level": 4,
      "risk_description": "高风险",
      "risk_score": 68.92,
      "confidence": 0.8923
    }
  ],
  "timestamp": "2024-01-01T12:00:00"
}
```

---

## 完整特征列表

模型需要110个特征，分为以下几类：

### 1. 基础数据（2个）
- `存活数`: HIV感染者存活人数
- `感染率`: 感染率（%）

### 2. 年龄分布（16个）
- `存活_0-`, `存活_5-`, `存活_10-`, ... `存活_80-`
- `新报告_0-`, `新报告_5-`, ... `新报告_80-`

### 3. 传播途径（16个）
- `存活_同性传播`, `存活_配偶阳性`, `存活_商业性行为`, ...
- `新报告_同性传播`, `新报告_配偶阳性`, ...

### 4. 治疗指标（5个）
- `治疗覆盖率`, `30天治疗比例`, `检测比例`, `病毒抑制比例`, `病载小于50占现存活比例`

### 5. 高危人群干预（30个）
- 暗娼相关（5个）
- MSM相关（5个）
- 吸毒者相关（5个）
- 性病就诊者相关（4个）
- 外来务工相关（5个）
- 其他人群相关（5个）

### 6. 人群规模（6个）
- `注射吸毒者规模`, `城市MSM规模`, `暗娼规模`, `嫖客规模`, `农村MSM规模`, `移动评估MSM人数`

### 7. 筛查数据（7个）
- `人口数`, `筛查人次数`, `筛查覆盖率`, `筛查人数`, `按人数筛查覆盖率`, ...

**获取完整列表**:
```bash
curl http://localhost:5000/v1/model/info | jq '.features'
```

---

## 常见场景

### 场景1: 快速评估单个区县

```python
import requests

# 准备数据（简化版，实际需要110个特征）
data = {
    "features": {
        "存活数": 1500,
        "感染率": 0.6,
        "治疗覆盖率": 88.0,
        "人口数": 600000
        # ... 其他特征
    }
}

# 发送请求
response = requests.post(
    "http://localhost:5000/v1/predict",
    json=data
)

# 解析结果
result = response.json()
if result['success']:
    pred = result['prediction']
    print(f"风险等级: {pred['risk_level']}")
    print(f"风险描述: {pred['risk_description']}")
    print(f"风险分数: {pred['risk_score']}")
    print(f"置信度: {pred['confidence_percent']}")
```

### 场景2: 批量评估生成报告

```python
import requests
import pandas as pd

# 读取区县数据
counties_data = pd.read_csv('counties.csv')

# 准备批量请求
samples = []
for _, row in counties_data.iterrows():
    features = row.to_dict()
    samples.append(features)

# 发送批量请求
response = requests.post(
    "http://localhost:5000/v1/predict/batch",
    json={"samples": samples}
)

# 生成报告
result = response.json()
if result['success']:
    for pred in result['predictions']:
        county_name = counties_data.iloc[pred['index']]['区县']
        print(f"{county_name}: {pred['risk_description']} ({pred['risk_score']:.2f}分)")
```

### 场景3: 定期监控

```python
import requests
import time

def check_county_risk(county_data):
    response = requests.post(
        "http://localhost:5000/v1/predict",
        json={"features": county_data}
    )
    return response.json()

# 每小时检查一次
while True:
    result = check_county_risk(county_data)
    if result['success']:
        risk_level = result['prediction']['risk_level']
        if risk_level >= 4:
            # 发送告警
            print(f"⚠️ 高风险告警！等级: {risk_level}")
    
    time.sleep(3600)  # 等待1小时
```

---

## 注意事项

### ⚠️ 重要提示

1. **特征完整性**: 
   - 必须提供所有110个特征
   - 缺失的特征会使用默认值0
   - 可能影响预测准确性

2. **数据格式**:
   - 所有数值必须是Number类型
   - 百分比用小数表示（如85.0表示85%）
   - 不要使用字符串

3. **性能考虑**:
   - 单次预测: <50ms
   - 批量预测: 建议每次不超过1000个样本
   - 并发请求: 支持100+ QPS

4. **错误处理**:
   - 始终检查`success`字段
   - 失败时查看`error`字段
   - 记录请求日志便于排查

---

**文档版本**: 1.0.0  
**最后更新**: 2024-01-01
